<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/base.css">
    <style>
        .state {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            font-size: 2em;
            transform: translate(-50%, -50%);
        }
    </style>
</head>

<body>

    <div class="state">START</div>

    <script type="module">

        import * as THREE from "./js/three.module.js";
        import { Session } from "./js/Session.js";

        const global_elem_state = document.querySelector('.state');

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true, });

        renderer.xr.enabled = true;
        renderer.setSize(window.innerWidth, window.innerHeight,);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setAnimationLoop(render);

        window.addEventListener('resize', onWindowResize);

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;  // æ›´æ–°è§†é”¥ä½“é•¿å®½æ¯”
            camera.updateProjectionMatrix();                         // æ›´æ–°æŠ•å½±çŸ©é˜µ

            renderer.setSize(window.innerWidth, window.innerHeight); // æ›´æ–°ç”»å¸ƒå°ºå¯¸

        }

        function render(timestamp, frame) {

            if (!renderer.xr.isPresenting) return;

            renderer.render(scene, camera);

        }

        Session(renderer, {}, onSessionStart, onSessionEnd).then(onSessionEnd);

        function onSessionStart(xr_session) {

            global_elem_state.style.display = 'none';

        }

        function onSessionEnd(xr_session) {

            global_elem_state.style.display = 'block';

            window.addEventListener('click', function once() {

                xr_session.on();

                this.removeEventListener('click', once);

            });

        }


        // PART: Please coding here ğŸ‘‡
        // ===================================================================================================== Start
        main();

        function main() {

            const render = (timestamp, frame) => {

                if (!renderer.xr.isPresenting) return;

                renderer.render(scene, camera);

                getXrViewerPose(frame);

            };

            renderer.setAnimationLoop(render);

        }

        // Description:
        //   This function must be run with xrFrame, so i put it in the new render function. It prints the pose infomation once per second.
        let count = 0;

        function getXrViewerPose(frame_xr) {

            // è§†å›¾é›†åˆ
            //   ğŸ”—https://developer.mozilla.org/en-US/docs/Web/API/XRView

            // ä½ç½®ã€æ–¹å‘ã€å˜æ¢çŸ©é˜µ
            //   ğŸ”—https://developer.mozilla.org/en-US/docs/Web/API/XRRigidTransform

            // position:
            //   å®ƒæ˜¯ä¸€ä¸ªç”¨äºæè¿°ä½ç½®ä¿¡æ¯çš„åæ ‡, æ•°æ®æ ¼å¼æ˜¯ä¸€ä¸ªå…·æœ‰å››ä¸ªå±æ€§ï¼ˆxã€yã€zã€yï¼‰çš„æ™®é€šå¯¹è±¡, å…¶ä¸­å±æ€§wæ€»æ˜¯ä¸º1, æ¯”å¦‚
            //   {x: -0.3126380145549774, y: -0.34387901425361633, z: -0.39460504055023193, w: 1}

            // orientation:
            //   å®ƒæ˜¯ä¸€ä¸ªç”¨äºæè¿°æ—‹è½¬ä¿¡æ¯çš„å››å…ƒæ•°, æ•°æ®æ ¼å¼æ˜¯ä¸€ä¸ªå…·æœ‰å››ä¸ªå±æ€§ï¼ˆxã€yã€zã€yï¼‰çš„æ™®é€šå¯¹è±¡, æ¯”å¦‚
            //   {x: -0.06293190413816015, y: -0.19456942672935154, z: -0.01636656613185102, w: 0.97873104024385}

            // matrix:
            //   å®ƒæ˜¯ä¸€ä¸ªå˜æ¢çŸ©é˜µï¼ˆè¿™ä¸ªå˜æ¢çŸ©é˜µæè¿°ä»€ä¹ˆå‘¢?ä½ç§»?æ—‹è½¬?ç¼©æ”¾?ï¼‰, æ•°æ®æ ¼å¼æ˜¯ä¸€ä¸ªå…·æœ‰16ä¸ªå…ƒç´ çš„Float32Array

            const space = renderer.xr.getReferenceSpace();    // å‚è€ƒç©ºé—´

            const pose = frame_xr.getViewerPose(space);       // å§¿æ€ï¼ˆè¿›å…¥xræ¨¡å¼åçš„å‰å‡ å¸§, poseå¯èƒ½ä¸ºnull, å› æ­¤ä¸‹æ–‡ä½¿ç”¨äº†å¯é€‰é“¾ï¼‰

            const views = pose?.views;                        // è§†å›¾é›†åˆ

            const view = views?.[0];                          // è§†å›¾

            const matrix_projection = view?.projectionMatrix; // æŠ•å½±å˜æ¢çŸ©é˜µ

            const position = view?.transform.position;        // ä½ç½®

            const orientation = view?.transform.orientation;  // æ–¹å‘

            const matrix = view?.transform.matrix;            // å˜æ¢çŸ©é˜µ

            if (count++ % 60 !== 0) return;

            console.log('Projection matrix: ', matrix_projection);
            console.log('Position         : ', position);
            console.log('Orientation      : ', orientation);
            console.log('Transform matrix : ', matrix);
            console.log('---------------------------------------------------------------------------------------------------------------------------------------')

        }

        // ----------------------------------------------------------------------------------------------------- E n d


    </script>

</body>

</html>